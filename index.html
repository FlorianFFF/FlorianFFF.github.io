<!DOCTYPE html>
<html lang="en">
<head>

<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1">

<link rel="stylesheet" href="./bootstrap.min.css">
<style type="text/css">
.header {
  padding-bottom: 10px;
  border-bottom: 1px solid #e5e5e5;
}

.footer {
  padding-top: 10px;
  color: #777;
  border-top: 1px solid #e5e5e5;
}
</style>

<script src="./d3.v3.min.js"></script>
<script src="./topojson.v1.min.js"></script>
<script src="./datamaps.none.min.js"></script>
<script src="./jquery-3.2.1.min.js"></script>
<script src="./bootstrap.min.js"></script>
</head>
<body>

<div class="container">
  <header class="header clearfix">
    <h1 class="">University selector</h1>
    <h3 class="text-muted">Select a university below</h3>
  </header>
  <div class="row">
    <div class="col-md-6">
      <div id="arcs" style="height: 500px; width: 486px;"></div>
    </div>
    <div class="col-md-6">
        <div class="row">
          <div class="col-md-12">Span 2</div>
        </div>
        <div class="row">
          <div class="col-md-12">
            <svg id="uni" width="486" height="486" font-family="sans-serif" font-size="10" text-anchor="middle"></svg>
          </div>
        </div>
    </div>
  </div>
  <footer class="footer">
    <p>&copy; 2017 Florian Fikkert &amp; Sander Koning</p>
  </footer>
</div>


<script>
  var map = new Datamap({
    element: document.getElementById('arcs'),
    geographyConfig: {
      dataUrl: 'new.json'
    },
    scope: 'townships',
    fills: {
      defaultFill: '#dbdbeb',
      hasUni: '#7577CD'
    },
    data: {
      "Amsterdam": {fillKey: "hasUni"},
      "Breda": {fillKey: "hasUni"},
      "Delft": {fillKey: "hasUni"},
      "Eindhoven": {fillKey: "hasUni"},
      "Enschede": {fillKey: "hasUni"},
      "Groningen (Gr)": {fillKey: "hasUni"},
      "Leiden": {fillKey: "hasUni"},
      "Maastricht": {fillKey: "hasUni"},
      "Nijmegen": {fillKey: "hasUni"},
      "Rotterdam": {fillKey: "hasUni"},
      "Tilburg": {fillKey: "hasUni"},
      "Utrecht (Ut)": {fillKey: "hasUni"},
      "Wageningen": {fillKey: "hasUni"}
    },
    setProjection: function(element) {
      var projection = d3.geo.mercator()
        .center([6, 52])
        .scale(6000)
        .translate([element.offsetWidth / 2 + 95, element.offsetHeight / 2 + 40]);

       var path = d3.geo.path().projection(projection);
       return {path: path, projection: projection};
    }
  });
  $(function(){
    $("#arcs").click(function(event){
      $("header > h3").text("");
      var target = $(event.target);
      if(target.hasClass("datamaps-subunit")){
        switch(target.attr("class").substring(17)){
          case "Amsterdam":
          case "Breda":
          case "Delft":
          case "Eindhoven":
          case "Enschede":
          case "Groningen (Gr)":
          case "Leiden":
          case "Maastricht":
          case "Nijmegen":
          case "Rotterdam":
          case "Tilburg":
          case "Utrecht (Ut)":
          case "Wageningen":
            $("header > h3").text(target.attr("class").substring(17));
            uni(target.attr("class").substring(17));
            break;
          default:
            $("header > h3").text("This municipality doesn't have a university");
        }
      }
    });
  });

  var diameter = 486,
      format = d3.format(",d"),
      color = d3.scale.category20c();

  var bubble = d3.layout.pack()
      .sort(null)
      .size([diameter, diameter])
      .padding(1.5);

  var svg = d3.select("#uni")
      .attr("class", "bubble");

  var tooltip = d3.select("body")
      .append("div")
      .style("position", "absolute")
      .style("z-index", "10")
      .style("visibility", "hidden")
      .style("color", "white")
      .style("padding", "8px")
      .style("background-color", "rgba(0, 0, 0, 0.75)")
      .style("border-radius", "6px")
      .style("font", "12px sans-serif")
      .text("tooltip");

  function uni(city){
    $("#uni").fadeOut("fast", function(){
      svg.html("");
      d3.json("Universiteiten/" + city +".json", function(error, root) {
        var node = svg.selectAll(".node")
            .data(bubble.nodes(classes(root))
            .filter(function(d) { return !d.children; }))
          .enter().append("g")
            .attr("class", "node")
            .attr("transform", function(d) { return "translate(" + d.x + "," + d.y + ")"; });

        node.append("circle")
            .attr("r", function(d) { return d.r; })
            .style("fill", function(d) { return color(d.className); })
            .on("mouseover", function(d) {
                    tooltip.text(d.className + ": " + format(d.value));
                    tooltip.style("visibility", "visible");
            })
            .on("mousemove", function() {
                return tooltip.style("top", (d3.event.pageY-10)+"px").style("left",(d3.event.pageX+10)+"px");
            })
            .on("mouseout", function(){return tooltip.style("visibility", "hidden");});

        node.append("text")
            .attr("dy", ".3em")
            .style("text-anchor", "middle")
            .style("pointer-events", "none")
            .text(function(d) { return d.className.substring(0, d.r / 3); });
      });
      $(this).fadeIn("fast");
    });
  }

  // Returns a flattened hierarchy containing all leaf nodes under the root.
  function classes(root) {
    var classes = [];

    function recurse(name, node) {
      if (node.children) node.children.forEach(function(child) { recurse(node.name, child); });
      else classes.push({packageName: name, className: node.name, value: node.size});
    }

    recurse(null, root);
    return {children: classes};
  }



</script>
</body>
</html>
